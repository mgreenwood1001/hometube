name: Create Release Package

on:
  push:
    branches:
      - main  # Run on every commit to main
    tags:
      - 'v*'  # Also trigger on version tags like v1.0.0
  workflow_dispatch:  # Allow manual triggering
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: false
        type: string

permissions:
  contents: write  # Required to create releases and push tags/commits

jobs:
  build-and-package:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run tests (if any)
        run: |
          if [ -f "package.json" ] && grep -q '"test"' package.json; then
            npm test
          else
            echo "No tests configured, skipping..."
          fi
        continue-on-error: true
      
      - name: Determine and update version
        id: version
        run: |
          # Skip auto-increment if this commit is a version bump (prevent infinite loop)
          COMMIT_MSG=$(git log -1 --pretty=%B)
          if [[ "$COMMIT_MSG" == *"chore: bump version"* ]]; then
            echo "Skipping version increment - this is a version bump commit"
            CURRENT_VERSION=$(node -p "require('./package.json').version")
            echo "version=${CURRENT_VERSION}" >> $GITHUB_OUTPUT
            echo "should_increment=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Determine version based on trigger
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # Tag-based release - use tag version
            VERSION=${GITHUB_REF#refs/tags/v}
            echo "version=${VERSION}" >> $GITHUB_OUTPUT
            echo "should_increment=false" >> $GITHUB_OUTPUT
          elif [ -n "${{ inputs.version }}" ]; then
            # Manual workflow with version input
            VERSION="${{ inputs.version }}"
            echo "version=${VERSION}" >> $GITHUB_OUTPUT
            echo "should_increment=true" >> $GITHUB_OUTPUT
          else
            # Branch commit - auto-increment patch version
            CURRENT_VERSION=$(node -p "require('./package.json').version")
            IFS='.' read -ra VERSION_PARTS <<< "$CURRENT_VERSION"
            MAJOR=${VERSION_PARTS[0]}
            MINOR=${VERSION_PARTS[1]}
            PATCH=${VERSION_PARTS[2]}
            
            # Increment patch version
            NEW_PATCH=$((PATCH + 1))
            VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}"
            
            echo "version=${VERSION}" >> $GITHUB_OUTPUT
            echo "should_increment=true" >> $GITHUB_OUTPUT
            echo "previous_version=${CURRENT_VERSION}" >> $GITHUB_OUTPUT
          fi
      
      - name: Update package.json version
        if: steps.version.outputs.should_increment == 'true'
        run: |
          npm version ${{ steps.version.outputs.version }} --no-git-tag-version
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add package.json
          git commit -m "chore: bump version to ${{ steps.version.outputs.version }}" || echo "No changes to commit"
      
      - name: Create git tag and push (for main branch)
        if: github.ref == 'refs/heads/main' && steps.version.outputs.should_increment == 'true'
        run: |
          # Create annotated tag
          git tag -a "v${{ steps.version.outputs.version }}" -m "Release v${{ steps.version.outputs.version }}"
          
          # Push the version commit and tag
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          git push origin HEAD:main
          git push origin "v${{ steps.version.outputs.version }}"
      
      - name: Create release package
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          PACKAGE_NAME="tube-video-browser-${VERSION}"
          
          echo "PACKAGE_NAME=${PACKAGE_NAME}" >> $GITHUB_ENV
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          
          # Create a clean package directory
          mkdir -p release-package
          
          # Copy necessary files
          cp -r public release-package/
          cp server.js release-package/
          cp package.json release-package/
          cp package-lock.json release-package/ 2>/dev/null || true
          cp config.example.json release-package/ 2>/dev/null || true
          cp README.md release-package/ 2>/dev/null || true
          cp .gitignore release-package/ 2>/dev/null || true
          
          # Create necessary directories
          mkdir -p release-package/thumbnails
          mkdir -p release-package/resolutions
          
          # Create a .gitkeep file for directories
          touch release-package/thumbnails/.gitkeep
          touch release-package/resolutions/.gitkeep
          
          # Create package archive
          cd release-package
          tar -czf "../${PACKAGE_NAME}.tar.gz" .
          cd ..
          
          # Also create a zip file
          cd release-package
          zip -r "../${PACKAGE_NAME}.zip" .
          cd ..
          
          echo "PACKAGE_NAME=${PACKAGE_NAME}" >> $GITHUB_ENV
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
      
      - name: Upload release package (tar.gz)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PACKAGE_NAME }}-tar.gz
          path: ${{ env.PACKAGE_NAME }}.tar.gz
          retention-days: 30
      
      - name: Upload release package (zip)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PACKAGE_NAME }}-zip
          path: ${{ env.PACKAGE_NAME }}.zip
          retention-days: 30
      
      - name: Create GitHub Release (Tags only)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ${{ env.PACKAGE_NAME }}.tar.gz
            ${{ env.PACKAGE_NAME }}.zip
          body: |
            ## Release ${{ env.VERSION }}
            
            ### Installation
            
            1. Extract the package:
               ```bash
               tar -xzf ${{ env.PACKAGE_NAME }}.tar.gz
               # or
               unzip ${{ env.PACKAGE_NAME }}.zip
               ```
            
            2. Install dependencies:
               ```bash
               npm install
               ```
            
            3. Configure the application:
               - Copy `config.example.json` to `config.json` and update settings
               - Create `credentials.txt` with username:password pairs
               - Create `filelist.txt` with your video/image/PDF file list
            
            4. Start the server:
               ```bash
               npm start
               ```
            
            ### Requirements
            
            - Node.js 20 or higher
            - FFmpeg (for video thumbnail generation)
            - See README.md for full details
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create Draft Release (Main branch)
        if: github.ref == 'refs/heads/main' && !startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ${{ env.PACKAGE_NAME }}.tar.gz
            ${{ env.PACKAGE_NAME }}.zip
          tag_name: "v${{ steps.version.outputs.version }}"
          name: "Release v${{ steps.version.outputs.version }}"
          body: |
            ## Release v${{ steps.version.outputs.version }}
            
            This is an automated release from the main branch.
            
            **Commit:** ${{ github.sha }}
            **Branch:** ${{ github.ref_name }}
            **Workflow:** ${{ github.workflow }}
            
            ### Installation
            
            1. Extract the package:
               ```bash
               tar -xzf ${{ env.PACKAGE_NAME }}.tar.gz
               # or
               unzip ${{ env.PACKAGE_NAME }}.zip
               ```
            
            2. Install dependencies:
               ```bash
               npm install
               ```
            
            3. Configure the application:
               - Copy `config.example.json` to `config.json` and update settings
               - Create `credentials.txt` with username:password pairs
               - Create `filelist.txt` with your video/image/PDF file list
            
            4. Start the server:
               ```bash
               npm start
               ```
          draft: true
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

